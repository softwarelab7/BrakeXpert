rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Products collection: Public Read, Authenticated Admin Write
    match /pastillas/{productId} {
      allow read: if true;
      
      // Allow write only for authenticated users with admin claim
      // Or restrict to a specific UID for management
      allow write: if request.auth != null && 
                  (request.auth.token.admin == true || request.auth.uid == 'IAiYdzGTKbeEQTPND3lKkzS1zSo2');
      
      // Data Validation
      function isValidProduct(data) {
        return data.referencia is string &&
               data.posicion in ['DELANTERA', 'TRASERA', 'AMBAS'] &&
               data.aplicaciones is list;
      }
      
      allow create, update: if isValidProduct(request.resource.data);
    }

    // History collection: Admin only
    match /history/{historyId} {
      allow read, write: if request.auth != null && 
                  (request.auth.token.admin == true || request.auth.uid == 'IAiYdzGTKbeEQTPND3lKkzS1zSo2');
    }

    // Default: Deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
